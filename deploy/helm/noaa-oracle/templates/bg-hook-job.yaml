{{- if .Values.blueGreen.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "noaa-oracle.fullname" . }}-bg-script
  labels:
    {{- include "noaa-oracle.labels" . | nindent 4 }}
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
data:
  bg-switchover.sh: |
{{ .Files.Get "files/bg-switchover.sh" | indent 4 }}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "noaa-oracle.fullname" . }}-bg-switchover
  labels:
    {{- include "noaa-oracle.labels" . | nindent 4 }}
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  backoffLimit: 0
  activeDeadlineSeconds: 900
  ttlSecondsAfterFinished: 300
  template:
    metadata:
      labels:
        {{- include "noaa-oracle.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: bg-switchover
    spec:
      serviceAccountName: {{ include "noaa-oracle.fullname" . }}-bg-hook
      restartPolicy: Never
      containers:
        - name: switchover
          image: bitnami/kubectl:latest
          command: ["/bin/bash", "/scripts/bg-switchover.sh"]
          env:
            - name: NAMESPACE
              value: "{{ .Release.Namespace }}"
            - name: SERVICE
              value: "{{ include "noaa-oracle.fullname" . }}"
            - name: DEPLOY_PREFIX
              value: "{{ include "noaa-oracle.fullname" . }}"
            - name: CONTAINER
              value: "{{ .Chart.Name }}"
            - name: NEW_IMAGE
              value: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
            - name: MOUNT_PATH
              value: "{{ .Values.persistence.mountPath }}"
            - name: APP_LABEL
              value: "{{ include "noaa-oracle.name" . }}"
            - name: WEATHER_RESTORE_ENABLED
              value: "true"
            - name: WEATHER_DATA_DIR
              value: "{{ .Values.config.dataDir }}"
            - name: WEATHER_S3_BUCKET
              value: "{{ .Values.litestream.s3Bucket }}"
            - name: WEATHER_S3_REGION
              value: "{{ .Values.litestream.s3Region }}"
          volumeMounts:
            - name: scripts
              mountPath: /scripts
          resources:
            requests:
              memory: 32Mi
              cpu: 10m
            limits:
              memory: 64Mi
      volumes:
        - name: scripts
          configMap:
            name: {{ include "noaa-oracle.fullname" . }}-bg-script
            defaultMode: 0755
{{- end }}
