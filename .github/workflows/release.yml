name: Release

on:
  push:
    tags:
      - "v*.*.*"

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # Extract version from tag
  prepare-release:
    name: Prepare Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      version_name: ${{ steps.get_version.outputs.version_name }}
    steps:
      - name: Get version from tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version_name=v$VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"

  # Update version in Cargo.toml files
  update-versions:
    name: Update Crate Versions
    runs-on: ubuntu-latest
    needs: prepare-release
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@main
        with:
          use-gha-cache: false
          use-flakehub: false

      - name: Install cargo-edit and update versions
        run: |
          VERSION="${{ needs.prepare-release.outputs.version }}"
          echo "Updating all crates to version $VERSION"
          nix develop -c cargo install cargo-edit --locked
          nix develop -c cargo set-version --workspace $VERSION

          echo "Updated versions:"
          grep "^version" Cargo.toml
          grep "^version" crates/*/Cargo.toml

      - name: Commit version updates
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Cargo.toml Cargo.lock crates/*/Cargo.toml
          git commit -m "chore: bump version to ${{ needs.prepare-release.outputs.version }}" || echo "No changes to commit"
          git push origin HEAD:master || echo "No changes to push"

  # Build release binaries using Nix
  build-release:
    name: Build Release
    runs-on: ubuntu-latest
    needs: [prepare-release, update-versions]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: master

      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force || true
          sudo apt-get clean || true

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@main
        with:
          use-gha-cache: false
          use-flakehub: false

      - name: Build with Nix
        run: |
          nix build .#oracle --print-build-logs
          nix build .#daemon --print-build-logs -o result-daemon

      - name: Build with Cargo (for compatibility)
        run: |
          nix develop -c cargo build --release --locked --workspace
        env:
          RUSTFLAGS: "-C link-arg=-fuse-ld=lld"

      - name: Create release package
        run: |
          VERSION="${{ needs.prepare-release.outputs.version }}"
          PKG_NAME="noaa-oracle-${VERSION}-x86_64-linux"

          mkdir -p "${PKG_NAME}/bin"
          mkdir -p "${PKG_NAME}/ui"
          mkdir -p "${PKG_NAME}/config"

          # Copy Nix-built binaries (preferred - fully static)
          cp result/bin/oracle "${PKG_NAME}/bin/"
          cp result-daemon/bin/daemon "${PKG_NAME}/bin/"

          # Copy UI
          cp -r ui/* "${PKG_NAME}/ui/"

          # Copy and rename config examples to usable defaults
          cp config/oracle.example.toml "${PKG_NAME}/config/oracle.toml"
          cp config/daemon.example.toml "${PKG_NAME}/config/daemon.toml"

          # Create a simple run script
          cat > "${PKG_NAME}/run-oracle.sh" << 'EOF'
          #!/bin/bash
          SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
          cd "$SCRIPT_DIR"

          # Generate signing key if not exists
          if [ ! -f "oracle_private_key.pem" ]; then
              echo "Generating oracle signing key..."
              openssl ecparam -genkey -name secp256k1 -out oracle_private_key.pem
              chmod 600 oracle_private_key.pem
          fi

          # Create data directories
          mkdir -p weather_data event_data logs

          export RUST_LOG="${RUST_LOG:-info}"
          exec ./bin/oracle "$@"
          EOF
          chmod +x "${PKG_NAME}/run-oracle.sh"

          cat > "${PKG_NAME}/run-daemon.sh" << 'EOF'
          #!/bin/bash
          SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
          cd "$SCRIPT_DIR"

          mkdir -p data logs

          export RUST_LOG="${RUST_LOG:-info}"
          exec ./bin/daemon "$@"
          EOF
          chmod +x "${PKG_NAME}/run-daemon.sh"

          # Create README
          cat > "${PKG_NAME}/README.txt" << EOF
          NOAA Oracle v${VERSION}
          =======================

          Quick Start:
            1. Run ./run-oracle.sh to start the oracle server (default port 9800)
            2. Run ./run-daemon.sh to start fetching NOAA weather data

          Configuration:
            - Edit config/oracle.toml for oracle settings
            - Edit config/daemon.toml for daemon settings

          Directories:
            - ui/           Browser UI files
            - config/       Configuration files
            - bin/          Binaries
            - weather_data/ Downloaded parquet files (created on first run)
            - event_data/   DLC event database (created on first run)

          For more info: https://github.com/tee8z/noaa-oracle
          EOF

          # Create zip
          zip -r "${PKG_NAME}.zip" "${PKG_NAME}"

          # Also create separate tarballs for cargo-built binaries
          mkdir -p release
          mv "${PKG_NAME}.zip" release/

          # Cargo binaries tarball (for users who prefer dynamic linking)
          mkdir -p cargo-pkg/bin
          cp target/release/oracle cargo-pkg/bin/
          cp target/release/daemon cargo-pkg/bin/
          tar czf "release/noaa-oracle-${VERSION}-x86_64-linux-cargo.tar.gz" -C cargo-pkg .
          rm -rf cargo-pkg

          ls -lh release/

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-x86_64-linux
          path: release/*
          retention-days: 7

  # Create GitHub release
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [prepare-release, build-release]
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -R artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ needs.prepare-release.outputs.version_name }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            artifacts/**/*.zip
            artifacts/**/*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
